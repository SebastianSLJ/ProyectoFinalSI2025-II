<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduciendo Ahora - Spotify</title>
    <link rel="stylesheet" href="../static/player.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>REPRODUCIENDO AHORA</h1>
        </div>
        
        <div class="now-playing">
            <div class="album-art">
                <img id="album-image" src="https://i.scdn.co/image/ab67616d0000b2734c71e27f7c5c0c7d5b4a7f8a" alt="Portada del álbum">
            </div>
            
            <div class="track-info">
                <h2 class="track-name" id="track-name">Blinding Lights</h2>
                <p class="artist-name" id="artist-name">The Weeknd</p>
                <p class="album-name" id="album-name">After Hours</p>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
                <div class="time-info">
                    <span id="current-time">2:15</span>
                    <span id="total-time">3:20</span>
                </div>
            </div>
            
            <div class="controls">
                <button class="control-btn" id="btn-previous">⏮</button>
                <button class="control-btn play-pause" id="btn-play-pause">⏸</button>
                <button class="control-btn" id="btn-next">⏭</button>
            </div>
        </div>
        
        <div class="footer">
            <p>Conectado a Spotify • Actualizado hace 5 segundos</p>
        </div>
    </div>
<script>
// Esperar a que el DOM esté completamente cargado
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM cargado, inicializando controles...');

  async function actualizar() {
    try {
      const response = await fetch('/estado');
      const data = await response.json();

      if (data.status) {
        // Si hay un mensaje de estado (probablemente "No se está reproduciendo nada")
        document.getElementById('track-name').textContent = data.status;
        document.getElementById('artist-name').textContent = '';
        document.getElementById('album-name').textContent = '';
        document.getElementById('album-image').src = '';
        document.getElementById('current-time').textContent = '0:00';
        document.getElementById('total-time').textContent = '0:00';
        document.querySelector('.progress').style.width = '0%';
        document.getElementById('btn-play-pause').textContent = '▶';
      } else {
        // Si hay una canción reproduciéndose
        document.getElementById('track-name').textContent = data.cancion;
        document.getElementById('artist-name').textContent = data.artista;
        document.getElementById('album-name').textContent = data.album;
        document.getElementById('album-image').src = data.imagen_album;
        
        // Actualizar tiempos y progreso con datos reales
        const currentMs = data.progress_ms || 0;
        const durationMs = data.duration_ms || 0;
        const currentMin = Math.floor(currentMs / 60000);
        const currentSec = Math.floor((currentMs % 60000) / 1000);
        
        document.getElementById('current-time').textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')}`;
        document.getElementById('total-time').textContent = data.duracion;
        document.querySelector('.progress').style.width = `${data.progress_percent || 0}%`;
        
        // Actualizar icono de play/pause según el estado
        if (data.is_playing) {
          document.getElementById('btn-play-pause').textContent = '⏸';
        } else {
          document.getElementById('btn-play-pause').textContent = '▶';
        }
      }
    } catch (err) {
      console.error("Error actualizando estado:", err);
      document.getElementById('track-name').textContent = 'No hay musica en reproducción';
      document.getElementById('artist-name').textContent = '';
      document.getElementById('album-name').textContent = '';
    }
  }

  // Función para pausar/reanudar
  async function togglePlayPause() {
    console.log('Botón play/pause clickeado');
    try {
      const response = await fetch('/api/play-pause', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      console.log('Respuesta play/pause:', data);
      
      if (response.ok) {
        if (data.status === 'paused') {
          document.getElementById('btn-play-pause').textContent = '▶';
        } else if (data.status === 'playing') {
          document.getElementById('btn-play-pause').textContent = '⏸';
        }
        // Actualizar el estado inmediatamente
        setTimeout(actualizar, 200);
      } else {
        // Mostrar error al usuario
        console.error('Error del servidor:', data.error);
        alert(data.error || 'No se pudo cambiar el estado de reproducción');
      }
    } catch (err) {
      console.error("Error al pausar/reanudar:", err);
      alert('Error de conexión. Verifica que el servidor esté corriendo.');
    }
  }

  // Función para siguiente canción
  async function nextTrack() {
    console.log('Botón siguiente clickeado');
    try {
      const response = await fetch('/api/next', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log('Respuesta next:', response.status);
      
      if (response.ok) {
        // Actualizar inmediatamente después de cambiar la canción
        setTimeout(actualizar, 500);
      } else {
        const data = await response.json();
        console.error('Error del servidor:', data.error);
        alert(data.error || 'No se pudo cambiar a la siguiente canción');
      }
    } catch (err) {
      console.error("Error al cambiar a siguiente canción:", err);
      alert('Error de conexión. Verifica que el servidor esté corriendo.');
    }
  }

  // Función para canción anterior
  async function previousTrack() {
    console.log('Botón anterior clickeado');
    try {
      const response = await fetch('/api/previous', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log('Respuesta previous:', response.status);
      
      if (response.ok) {
        // Actualizar inmediatamente después de cambiar la canción
        setTimeout(actualizar, 500);
      } else {
        const data = await response.json();
        console.error('Error del servidor:', data.error);
        alert(data.error || 'No se pudo cambiar a la canción anterior');
      }
    } catch (err) {
      console.error("Error al cambiar a canción anterior:", err);
      alert('Error de conexión. Verifica que el servidor esté corriendo.');
    }
  }

  // Función para buscar en la línea de tiempo
  async function seekToPosition(positionMs) {
    try {
      const response = await fetch(`/api/seek?position_ms=${positionMs}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        // Actualizar inmediatamente después de buscar
        setTimeout(actualizar, 200);
      } else {
        const data = await response.json();
        console.error('Error del servidor:', data.error);
      }
    } catch (err) {
      console.error("Error al buscar en la canción:", err);
    }
  }

  // Event listeners para los botones
  const btnPlayPause = document.getElementById('btn-play-pause');
  const btnNext = document.getElementById('btn-next');
  const btnPrevious = document.getElementById('btn-previous');
  const progressBar = document.querySelector('.progress-bar');
  
  if (btnPlayPause) {
    btnPlayPause.addEventListener('click', togglePlayPause);
    console.log('Event listener agregado a play/pause');
  } else {
    console.error('No se encontró el botón play/pause');
  }
  
  if (btnNext) {
    btnNext.addEventListener('click', nextTrack);
    console.log('Event listener agregado a siguiente');
  } else {
    console.error('No se encontró el botón siguiente');
  }
  
  if (btnPrevious) {
    btnPrevious.addEventListener('click', previousTrack);
    console.log('Event listener agregado a anterior');
  } else {
    console.error('No se encontró el botón anterior');
  }

  // Event listener para hacer clickeable la barra de progreso
  if (progressBar) {
    progressBar.addEventListener('click', async function(e) {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percentClicked = clickX / rect.width;
      
      // Obtener la duración actual de la canción
      try {
        const response = await fetch('/estado');
        const data = await response.json();
        
        if (data.duration_ms) {
          const positionMs = Math.floor(data.duration_ms * percentClicked);
          await seekToPosition(positionMs);
        }
      } catch (err) {
        console.error('Error al obtener duración:', err);
      }
    });
    
    // Cambiar cursor al pasar sobre la barra
    progressBar.style.cursor = 'pointer';
    console.log('Event listener agregado a barra de progreso');
  }

  // Actualiza cada 1 segundo para respuesta casi instantánea
  setInterval(actualizar, 1000);
  actualizar();
});
</script>
</body>
</html>